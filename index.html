<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="style.css" />
    <title>Visualizer</title>
  </head>
  <body>
    <div class="box">
      <div class="visualizer"></div>
    </div>
    <div class="play">
      <!-- <div class="btn btn-play"></div> -->
    </div>
    <script>
      const visualizer = document.querySelector(".visualizer");

      let recognition;
      let isListening = false;
      let mediaStream;

      function initRecognition() {
        if (!recognition) {
          recognition = new (window.SpeechRecognition ||
            window.webkitSpeechRecognition ||
            window.mozSpeechRecognition ||
            window.msSpeechRecognition)();
          recognition.continuous = false;
          recognition.interimResults = true;
        }

        recognition.onresult = (event) => {
          console.log(event);
          const transcript = Array.from(event.results) // e.results is a list of all the words that have been recognized
            .map((result) => result[0]) // result[0] is the first alternative of the most recent SpeechRecognitionResult
            .map((result) => result.transcript) // result.transcript is the recognized word
            .join(""); // join all the words into a single string
          transcript; // set tempWords to the string of all the words
          console.log("tempwords : ", transcript);
        };
        // Event listener for when the speech recognition starts
        recognition.onstart = (e) => {
          console.log("Recognition started.");
        };

        // Event listener for when the speech recognition ends
        recognition.onend = () => {
          if (isListening) {
            recognition.start();
          }
        };
      }

      function startUserMedia() {
        navigator.mediaDevices
          .getUserMedia({ audio: true })
          .then((stream) => {
            mediaStream = stream;
            const ctx = new (window.AudioContext || window.AudioContext)();
            const analyser = ctx.createAnalyser();
            const source = ctx.createMediaStreamSource(mediaStream);
            source.connect(analyser);
            initRecognition();
            recognition.start();
            isListening = true;
            // Event listener for when the speech recognition receives results
            // for returning my voice
            // source.connect(ctx.destination);
            analyser.fftSize = 64;
            const bufferLength = analyser.frequencyBinCount;

            let dataArray = new Uint8Array(bufferLength);
            let elements = [];
            for (let i = 0; i < bufferLength; i++) {
              const element = document.createElement("span");
              element.classList.add("element");
              elements.push(element);
              visualizer.appendChild(element);
            }

            const clamp = (num, min, max) => {
              if (num >= max) return max;
              if (num <= min) return min;
              return num;
            };

            const update = () => {
              requestAnimationFrame(update);
              analyser.getByteFrequencyData(dataArray);
              for (let i = 0; i < bufferLength; i++) {
                let item = dataArray[i];
                item = item > 150 ? item / 1.5 : item * 1.5;
                elements[i].style.transform = `rotateZ(${
                  i * (360 / bufferLength)
                }deg) translate(-50%, ${clamp(item, 100, 150)}px)`;
              }
            };
            update();
          })
          .catch((error) => {
            console.log(error);
            // Handle the error
          });
      }

      function stopUserMedia() {
        if (mediaStream) {
          mediaStream.getTracks().forEach((track) => track.stop());
          mediaStream = null;
        }
      }

      //   window.addEventListener("message", (ev) => {
      //     if (ev.origin == "http://localhost:4200") {
      //       if (ev.data == "hello") {
      //         startUserMedia();
      //       } else {
      //         console.log("i am here");
      //         stopUserMedia();
      //       }
      //     }
      //   });
      startUserMedia();
    </script>
  </body>
</html>
